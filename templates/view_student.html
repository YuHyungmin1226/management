{% extends "base.html" %}

{% block title %}{{ student.name }} 학생 정보{% endblock %}

{% block content %}
<div class="container">
    <!-- 헤더 -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('index') }}">
                            <i class="bi bi-house-fill me-1"></i>홈
                        </a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                        <i class="bi bi-person-fill me-1"></i>{{ student.name }}
                    </li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- 학생 정보 카드 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">
                        <i class="bi bi-person-fill me-2"></i>{{ student.name }} 학생 정보
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label text-muted">
                                    <i class="bi bi-hash me-1"></i>학번
                                </label>
                                <div class="h5">
                                    <span class="badge bg-primary fs-6">{{ student.student_number }}</span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-muted">
                                    <i class="bi bi-person me-1"></i>이름
                                </label>
                                <div class="h5">{{ student.name }}</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label text-muted">
                                    <i class="bi bi-calendar-plus me-1"></i>등록일
                                </label>
                                <div class="h6">{{ student.created_at.strftime('%Y년 %m월 %d일 %H:%M') }}</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-muted">
                                    <i class="bi bi-calendar-check me-1"></i>최근 수정일
                                </label>
                                <div class="h6">{{ student.last_modified.strftime('%Y년 %m월 %d일 %H:%M') }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="row">
                                <div class="col-4">
                                    <div class="text-center p-3 bg-light rounded">
                                        <div class="h4 text-primary mb-1">{{ student.evaluations|length }}</div>
                                        <small class="text-muted">총 평가 수</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="text-center p-3 bg-light rounded">
                                        <div class="h4 text-success mb-1">
                                            {% if student.evaluations %}
                                                {{ "%.1f"|format(student.evaluations|map(attribute='score')|sum / student.evaluations|length) }}
                                            {% else %}
                                                0
                                            {% endif %}
                                        </div>
                                        <small class="text-muted">평균 점수</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="text-center p-3 bg-light rounded">
                                        <div class="h4 text-warning mb-1">
                                            {% if student.evaluations %}
                                                {{ student.evaluations|map(attribute='score')|max }}
                                            {% else %}
                                                0
                                            {% endif %}
                                        </div>
                                        <small class="text-muted">최고 점수</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <a href="{{ url_for('edit_student', student_id=student.id) }}" class="btn btn-outline-primary">
                            <i class="bi bi-pencil-fill me-2"></i>학생 정보 수정
                        </a>
                        <form action="{{ url_for('delete_student', student_id=student.id) }}" 
                              method="POST" 
                              class="d-inline" 
                              onsubmit="return confirm('정말로 이 학생을 삭제하시겠습니까?\n\n⚠️ 모든 평가 기록도 함께 삭제됩니다.');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-outline-danger">
                                <i class="bi bi-trash-fill me-2"></i>학생 삭제
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 평가 섹션 -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
                <i class="bi bi-clipboard-data me-2"></i>평가 기록
            </h4>
                         <div class="action-buttons">
                 <a href="{{ url_for('add_evaluation', student_id=student.id) }}" class="btn btn-outline-light">
                     <i class="bi bi-plus-circle-fill me-2"></i>새 평가 추가
                 </a>
                 <a href="{{ url_for('export_student_evaluations', student_id=student.id) }}" class="btn btn-outline-light">
                     <i class="bi bi-download me-2"></i>이 학생 CSV
                 </a>
                 <a href="{{ url_for('export_all_evaluations') }}" class="btn btn-outline-light">
                     <i class="bi bi-download me-2"></i>전체 평가 CSV
                 </a>
             </div>
        </div>
        <div class="card-body">
            {% if student.evaluations %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th><i class="bi bi-book me-1"></i>과목</th>
                            <th><i class="bi bi-star me-1"></i>점수</th>
                            <th><i class="bi bi-calendar me-1"></i>평가일</th>
                            <th><i class="bi bi-chat-text me-1"></i>평가 내용</th>
                            <th><i class="bi bi-gear me-1"></i>작업</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for evaluation in student.evaluations|sort(attribute='evaluation_date', reverse=true) %}
                        <tr>
                            <td>
                                <span class="badge bg-secondary">{{ evaluation.subject }}</span>
                            </td>
                            <td>
                                {% if evaluation.score > 0 %}
                                    <span class="badge bg-success">+{{ evaluation.score }}</span>
                                {% elif evaluation.score < 0 %}
                                    <span class="badge bg-danger">{{ evaluation.score }}</span>
                                {% else %}
                                    <span class="badge bg-warning">{{ evaluation.score }}</span>
                                {% endif %}
                            </td>
                            <td>{{ evaluation.evaluation_date.strftime('%Y년 %m월 %d일') }}</td>
                            <td>
                                {% if evaluation.notes %}
                                    <span class="text-muted">{{ evaluation.notes }}</span>
                                {% else %}
                                    <span class="text-muted fst-italic">평가 내용 없음</span>
                                {% endif %}
                            </td>
                                                                                     <td class="text-center">
                                <div class="btn-group" role="group">
                                    <a href="{{ url_for('edit_evaluation', evaluation_id=evaluation.id) }}" 
                                       class="btn btn-warning btn-sm" 
                                       title="수정">
                                        <i class="bi bi-pencil-fill"></i>
                                    </a>
                                    <form action="{{ url_for('delete_evaluation', evaluation_id=evaluation.id) }}" 
                                          method="POST" 
                                          class="d-inline" 
                                          onsubmit="return confirm('정말로 이 평가를 삭제하시겠습니까?');">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn btn-danger btn-sm" title="평가 삭제">
                                            <i class="bi bi-trash-fill"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- 평가 통계 -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <h5><i class="bi bi-graph-up me-2"></i>과목별 통계</h5>
                    <div class="list-group">
                        {% for subject in (student.evaluations|map(attribute='subject')|list)|unique %}
                        {% set subject_evaluations = student.evaluations|selectattr('subject', 'equalto', subject)|list %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>{{ subject }}</span>
                            <span class="badge bg-primary rounded-pill">{{ subject_evaluations|length }}개</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="col-md-6">
                    <h5><i class="bi bi-calendar-range me-2"></i>최근 평가</h5>
                    <div class="list-group">
                        {% for evaluation in (student.evaluations|sort(attribute='evaluation_date', reverse=true))[:5] %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <strong>{{ evaluation.subject }}</strong>
                                    <small class="text-muted ms-2">{{ evaluation.evaluation_date.strftime('%Y년 %m월 %d일') }}</small>
                                </div>
                                <span class="badge {% if evaluation.score > 0 %}bg-success{% elif evaluation.score < 0 %}bg-danger{% else %}bg-warning{% endif %}">
                                    {{ evaluation.score }}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% else %}
                         <!-- 빈 상태 -->
             <div class="empty-state">
                 <div class="d-flex align-items-center justify-content-center empty-state-container">
                     <div class="text-center">
                         <i class="bi bi-clipboard display-1 text-muted mb-3"></i>
                         <h4 class="text-muted">등록된 평가가 없습니다</h4>
                     </div>
                 </div>
             </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}